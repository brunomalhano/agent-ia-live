name: Post-Deploy Validation

on:
  workflow_run:
    workflows: ["Deploy Azure Function"]
    types: [completed]
  schedule:
    - cron: '0 */6 * * *'  # A cada 6 horas
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for Function startup
        run: sleep 30
      
      - name: Health check
        run: |
          echo "üîç Verificando sa√∫de da fun√ß√£o..."
          curl -i -X OPTIONS "${{ secrets.FUNCAPP_URL }}/api/agent" \
            -H "Origin: https://portal.azure.com" \
            -w "\n"
      
      - name: Test with problem (with critic)
        run: |
          echo "üß™ Teste 1: Chatbot com cr√≠tica..."
          RESPONSE=$(curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{
              "problem": "Chatbot de suporte ao cliente usando IA",
              "critic": true
            }' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Teste 1: PASSOU (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Teste 1: FALHOU (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      - name: Test with problem (without critic)
        run: |
          echo "üß™ Teste 2: Arquitetura sem cr√≠tica..."
          RESPONSE=$(curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{
              "problem": "Arquitetura serverless para processar 100k eventos/min em tempo real",
              "critic": false
            }' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Teste 2: PASSOU (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Teste 2: FALHOU (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      - name: Test invalid request
        run: |
          echo "üß™ Teste 3: Valida√ß√£o de erro (problema muito curto)..."
          RESPONSE=$(curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{
              "problem": "abc",
              "critic": false
            }' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "400" ]; then
            echo "‚úÖ Teste 3: PASSOU (valida√ß√£o funcionando, HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è  Teste 3: HTTP $HTTP_CODE (esperado 400)"
          fi
      
      - name: Performance check
        run: |
          echo "‚è±Ô∏è  Verificando performance..."
          START_TIME=$(date +%s%N)
          
          curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{"problem": "Teste de performance", "critic": false}' \
            > /dev/null
          
          END_TIME=$(date +%s%N)
          DURATION=$((($END_TIME - $START_TIME) / 1000000))
          
          echo "Tempo de resposta: ${DURATION}ms"
          if [ $DURATION -lt 60000 ]; then
            echo "‚úÖ Performance OK (< 60s)"
          else
            echo "‚ö†Ô∏è  Performance lenta (> 60s)"
          fi
      
      - name: Notify Slack - Validation Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            payload.attachments = [{
              color: 'good',
              text: '‚úÖ Validation successful - guruarchtech',
              fields: [{
                title: 'Status',
                value: 'All tests passed',
                short: true
              }, {
                title: 'Time',
                value: new Date().toLocaleString(),
                short: true
              }]
            }]
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
      
      - name: Notify Slack - Validation Failed
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            payload.attachments = [{
              color: 'danger',
              text: '‚ùå Validation failed - guruarchtech',
              fields: [{
                title: 'Check',
                value: 'One or more tests failed',
                short: false
              }]
            }]
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
