name: Deploy Azure Function

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate Python syntax
        run: |
          python -m py_compile agent/__init__.py
          python -m py_compile agent/agent_logic.py
      
      - name: Verify files
        run: |
          ls -la agent/
          cat host.json
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: function-build
          path: |
            agent/
            requirements.txt
            host.json
            local.settings.example.json
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: function-build
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Install Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/microsoft.gpg] https://packages.microsoft.com/repos/azure-cli/ jammy main" > /etc/apt/sources.list.d/azure-cli.list'
          sudo apt-get update
          sudo apt-get install -y azure-functions-core-tools-4
      
      - name: Publish Function App
        run: |
          func azure functionapp publish ${{ secrets.FUNCAPP_NAME }} --build remote
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Verify function is online
        run: |
          echo "Verificando se função está online..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I "${{ secrets.FUNCAPP_URL }}/api/agent")
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Função está online (HTTP $HTTP_CODE)"
          else
            echo "❌ Função não está respondendo (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      - name: Validate deployment - Test 1 (with critic)
        if: ${{ secrets.FUNCAPP_CODE != '' }}
        run: |
          echo "Testando função com crítica..."
          RESPONSE=$(curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{"problem": "Chatbot de suporte ao cliente", "critic": true}' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Teste 1 (com crítica): PASSOU"
          else
            echo "❌ Teste 1 FALHOU com HTTP $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: Test note - FUNCAPP_CODE not configured
        if: ${{ secrets.FUNCAPP_CODE == '' }}
        run: |
          echo "⚠️  FUNCAPP_CODE secret não está configurado"
          echo "Para testes completos, configure o secret FUNCAPP_CODE no GitHub"
          echo "Function está online e pronta para uso!"
      
      - name: Validate deployment - Test 2 (without critic)
        if: ${{ secrets.FUNCAPP_CODE != '' }}
        run: |
          echo "Testando função sem crítica..."
          RESPONSE=$(curl -s -X POST "${{ secrets.FUNCAPP_URL }}/api/agent?code=${{ secrets.FUNCAPP_CODE }}" \
            -H "Content-Type: application/json" \
            -d '{"problem": "Arquitetura serverless para 100k eventos", "critic": false}' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Teste 2 (sem crítica): PASSOU"
          else
            echo "❌ Teste 2 FALHOU com HTTP $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: Notify Slack (Success)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            payload.attachments = [{
              color: 'good',
              text: '✅ Deploy successful - guruarchtech',
              fields: [{
                title: 'Function',
                value: 'agent',
                short: true
              }, {
                title: 'Branch',
                value: 'main',
                short: true
              }]
            }]
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
      
      - name: Notify Slack (Failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            payload.attachments = [{
              color: 'danger',
              text: '❌ Deploy failed - guruarchtech',
              fields: [{
                title: 'Check logs',
                value: 'GitHub Actions',
                short: false
              }]
            }]
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
